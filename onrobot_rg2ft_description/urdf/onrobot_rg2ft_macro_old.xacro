<?xml version="1.0"?>
<robot name="onrobot_rg2ft" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <xacro:include filename="$(find onrobot_rg2ft_description)/urdf/onrobot_rg2ft_transmission.xacro" />
  <xacro:include filename="$(find onrobot_rg2ft_description)/urdf/onrobot_rg2ft_gazebo.xacro" />

  <xacro:macro name="onrobot_rg2ft"
    params="
    prefix 
    parent
    hw_interface
    *origin"
  >

    <xacro:onrobot_rg2ft_transmission prefix="${prefix}" hw_interface="${hw_interface}" />
    <xacro:onrobot_rg2ft_gazebo prefix="${prefix}" />

    <xacro:property name="lower_limit" value="0" />
    <xacro:property name="upper_limit" value="2" />
    <xacro:property name="max_effort" value="50.0" />
    <xacro:property name="max_velocity" value="2.0" />

    <material name="silver">
      <color rgba="0.700 0.700 0.700 1.000"/>
    </material>
    <material name="blue">
      <color rgba="${55/255} ${151/255} ${207/255} 1.000"/>
    </material>

    <!-- fingers links macros -->
    <xacro:macro name="outer_knuckle" params="prefix fingerprefix">
      <link name="${prefix}${fingerprefix}_outer_knuckle">
        <inertial>
          <origin xyz="0.01231204747983699 0.010369678145260136 0.01020375918419171"
            rpy="0 0 0" />
          <mass value="0.04158368628179342" />
          <inertia ixx="1e-05" iyy="1.6e-05" izz="1e-05" ixy="-0.0" iyz="-0.0" ixz="-7e-06" />
        </inertial>
        <visual>
          <origin xyz="-0.017 0.009534 -0.122898" rpy="0 0 0" />
          <geometry>
            <mesh
              filename="package://onrobot_rg2ft_description/meshes/visual/outer_knuckle.stl"
              scale="0.001 0.001 0.001" />
          </geometry>
          <material name="silver" />
        </visual>
        <collision>
          <origin xyz="-0.017 0.009534 -0.122898" rpy="0 0 0" />
          <geometry>
            <mesh
              filename="package://onrobot_rg2ft_description/meshes/visual/outer_knuckle.stl"
              scale="0.001 0.001 0.001" />
          </geometry>
        </collision>
      </link>
    </xacro:macro>

    <xacro:macro name="inner_knuckle" params="prefix fingerprefix">
      <link name="${prefix}${fingerprefix}_inner_knuckle">
        <inertial>
          <origin xyz="0.017629472359448888 0.010272065844727667 0.017070505265307206"
            rpy="0 0 0" />
          <mass value="0.0243370951582674" />
          <inertia ixx="5e-06" iyy="7e-06" izz="5e-06" ixy="-0.0" iyz="-0.0" ixz="-3e-06" />
        </inertial>
        <visual>
          <origin xyz="-0.0075 0.009367 -0.139397" rpy="0 0 0" />
          <geometry>
            <mesh
              filename="package://onrobot_rg2ft_description/meshes/visual/inner_knuckle.stl"
              scale="0.001 0.001 0.001" />
          </geometry>
          <material name="silver" />
        </visual>
        <collision>
          <origin xyz="-0.0075 0.009367 -0.139397" rpy="0 0 0" />
          <geometry>
            <mesh
              filename="package://onrobot_rg2ft_description/meshes/visual/inner_knuckle.stl"
              scale="0.001 0.001 0.001" />
          </geometry>
        </collision>
      </link>
    </xacro:macro>

    <xacro:macro name="inner_finger" params="prefix fingerprefix">
      <link name="${prefix}${fingerprefix}_inner_finger">
        <inertial>
          <origin xyz="-0.009341477027312806 0.006108535220686467 0.03133683897712786"
            rpy="0 0 0" />
          <mass value="0.03203868115594587" />
          <inertia ixx="9e-06" iyy="9e-06" izz="2e-06" ixy="0.0" iyz="-0.0" ixz="2e-06" />
        </inertial>
        <visual>
          <origin xyz="-0.056748 0.00475 -0.160866" rpy="0 0 0" />
          <geometry>
            <mesh
              filename="package://onrobot_rg2ft_description/meshes/visual/inner_finger.stl"
              scale="0.001 0.001 0.001" />
          </geometry>
          <material name="silver" />
        </visual>
        <collision>
          <origin xyz="-0.056748 0.00475 -0.160866" rpy="0 0 0" />
          <geometry>
            <mesh
              filename="package://onrobot_rg2ft_description/meshes/visual/inner_finger.stl"
              scale="0.001 0.001 0.001" />
          </geometry>
        </collision>
      </link>
    </xacro:macro>


    <xacro:macro name="finger_links" params="prefix fingerprefix">
      <xacro:outer_knuckle prefix="${prefix}" fingerprefix="${fingerprefix}" />
      <!-- <xacro:inner_knuckle prefix="${prefix}" fingerprefix="${fingerprefix}" /> -->
      <xacro:inner_finger prefix="${prefix}" fingerprefix="${fingerprefix}" />
    </xacro:macro>


    <!-- fingers joints macros -->
    <xacro:macro name="inner_finger_joint" params="prefix fingerprefix">
      <joint name="${prefix}${fingerprefix}_inner_finger_joint" type="revolute">
        <origin xyz="0.039748 0.004784 0.037968" rpy="0 ${-23.8 *pi/180} 0" />
        <parent link="${prefix}${fingerprefix}_outer_knuckle" />
        <child link="${prefix}${fingerprefix}_inner_finger" />
        <axis xyz="-0.0 0.999949 -0.010122" />
        <limit lower="${lower_limit-0.01}" upper="${upper_limit+0.01}" velocity="${max_velocity}"
          effort="${max_effort}" />
        <mimic joint="${prefix}finger_joint" multiplier="1" offset="0" />
      </joint>
    </xacro:macro>


    <xacro:macro name="inner_knuckle_joint" params="prefix fingerprefix reflect">
      <joint name="${prefix}${fingerprefix}_inner_knuckle_joint" type="revolute">
        <!-- inaccurate 0.022 should be 0.0206 -->
        <origin
          xyz="
          ${(-1 + reflect)/(-2)*(0.03455  - 0.015) + (1 + reflect)/(2)*(0.03455)}
          ${(-1 + reflect)/(-2)*(-0.009367  + 0.0206) + (1 + reflect)/(2)*(-0.009367)}
          0.092397
          "
          rpy="0 ${23.8 *pi/180} ${(-1 + reflect) * pi / 2}"
        />
        <parent link="${prefix}gripper_body" />
        <child link="${prefix}${fingerprefix}_inner_knuckle" />
        <axis xyz="-0.0 0.999949 -0.010122" />
        <limit lower="${lower_limit-0.01}" upper="${upper_limit+0.01}" velocity="${max_velocity}"
          effort="${max_effort}" />
        <mimic joint="${prefix}finger_joint" multiplier="-1" offset="0" />
      </joint>
    </xacro:macro>


    <xacro:macro name="inner_knuckle_to_finger_joint" params="prefix fingerprefix">
      <!-- This joint closes the kinematic loop. Since loops are not allowed in URDF, but they are
      allowed in SDF, this is an SDF fragment. -->
      <gazebo>
        <joint name="${prefix}${fingerprefix}_inner_knuckle_to_finger_joint" type="revolute">
          <pose> -0.020673 0 0.007524 0 0 0</pose>
          <axis>
            <xyz>0 1 0</xyz>
            <use_parent_model_frame>false</use_parent_model_frame>
          </axis>
          <parent>${prefix}${fingerprefix}_inner_knuckle</parent>
          <child>${prefix}${fingerprefix}_finger</child>
        </joint>
      </gazebo>
    </xacro:macro>

    <xacro:macro name="finger_joints" params="prefix fingerprefix reflect">
      <xacro:inner_finger_joint prefix="${prefix}" fingerprefix="${fingerprefix}" />
      <!-- <xacro:inner_knuckle_joint prefix="${prefix}" fingerprefix="${fingerprefix}"
        reflect="${reflect}" /> -->
      <!-- <xacro:inner_knuckle_to_finger_joint prefix="${prefix}" fingerprefix="${fingerprefix}" /> -->
    </xacro:macro>


    <!-- left finger -->
    <xacro:finger_links prefix="${prefix}" fingerprefix="left" />
    <xacro:finger_joints prefix="${prefix}" fingerprefix="left" reflect="1.0" />
    <joint name="${prefix}finger_joint" type="revolute">
      <origin xyz="0.04405 -0.009534 0.075898" rpy="0 ${23.8 *pi/180} 0" />
      <parent link="${prefix}gripper_body" />
      <child link="${prefix}left_outer_knuckle" />
      <axis xyz="-0.0 -0.999949 0.010122" />
      <limit lower="${lower_limit}" upper="${upper_limit}" velocity="${max_velocity}"
        effort="${max_effort}" />
    </joint>


    <!-- right finger -->
    <xacro:finger_joints prefix="${prefix}" fingerprefix="right" reflect="-1.0" />
    <xacro:finger_links prefix="${prefix}" fingerprefix="right" />
    <joint name="${prefix}right_outer_knuckle_joint" type="revolute">
      <!-- inaccurate 0.022 should be 0.0206 -->
      <origin xyz="${0.04405-0.034} ${-0.009534+0.0214} 0.075898" rpy="0 ${23.8 *pi/180} ${pi}" />
      <parent link="${prefix}gripper_body" />
      <child link="${prefix}right_outer_knuckle" />
      <axis xyz="-0.0 -0.999949 0.010122" />
      <limit lower="${lower_limit-0.01}" upper="${upper_limit+0.01}" velocity="${max_velocity}"
        effort="${max_effort}" />
      <mimic joint="${prefix}finger_joint" multiplier="1" offset="0" />
    </joint>


    <link name="${prefix}quick_changer">
      <inertial>
        <origin xyz="0.0014673787228634701 -0.0007395056519161622 0.00391087859435364"
          rpy="0 0 0" />
        <mass value="0.05802030412577654" />
        <inertia ixx="2e-05" iyy="2.7e-05" izz="4.5e-05" ixy="-0.0" iyz="0.0" ixz="-0.0" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://onrobot_rg2ft_description/meshes/visual/quick_changer.stl"
            scale="0.001 0.001 0.001" />
        </geometry>
        <material name="blue" />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://onrobot_rg2ft_description/meshes/visual/quick_changer.stl"
            scale="0.001 0.001 0.001" />
        </geometry>
      </collision>
    </link>
    <joint name="${prefix}quick_changer_joint" type="fixed">
      <parent link="${parent}" />
      <child link="${prefix}quick_changer" />
      <xacro:insert_block name="origin" />
    </joint>
    <link name="${prefix}angle_bracket">
      <inertial>
        <origin xyz="-0.00023577776357350244 0.0006406606087327927 0.019938614519864756"
          rpy="0 0 0" />
        <mass value="0.19757034519537245" />
        <inertia ixx="9.8e-05" iyy="0.000145" izz="0.000155" ixy="-0.0" iyz="2e-06"
          ixz="-1e-06" />
      </inertial>
      <visual>
        <origin xyz="-0.0 -0.0 -0.00255" rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://onrobot_rg2ft_description/meshes/visual/angle_bracket.stl"
            scale="0.001 0.001 0.001" />
        </geometry>
        <material name="silver" />
      </visual>
      <collision>
        <origin xyz="-0.0 -0.0 -0.00255" rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://onrobot_rg2ft_description/meshes/visual/angle_bracket.stl"
            scale="0.001 0.001 0.001" />
        </geometry>
      </collision>
    </link>
    <joint name="${prefix}angle_bracket_joint" type="fixed">
      <origin xyz="0.0 0.0 0.00255" rpy="0 0 0" />
      <parent link="${prefix}quick_changer" />
      <child link="${prefix}angle_bracket" />
    </joint>
    <link name="${prefix}gripper_body">
      <inertial>
        <origin xyz="0.0272971231150397 -0.002438088956580745 0.035297715994502724"
          rpy="0 0 0" />
        <mass value="0.5707794664902835" />
        <inertia ixx="0.000622" iyy="0.000662" izz="0.000226" ixy="3e-06" iyz="1.8e-05"
          ixz="0.0" />
      </inertial>
      <visual>
        <origin xyz="0.02705 -0.0 -0.047" rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://onrobot_rg2ft_description/meshes/visual/gripper_body.stl"
            scale="0.001 0.001 0.001" />
        </geometry>
        <material name="silver" />
      </visual>
      <collision>
        <origin xyz="0.02705 -0.0 -0.047" rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://onrobot_rg2ft_description/meshes/visual/gripper_body.stl"
            scale="0.001 0.001 0.001" />
        </geometry>
      </collision>
    </link>
    <joint name="${prefix}gripper_body_joint" type="fixed">
      <origin xyz="-0.02705 0.0 0.04445" rpy="${.58 * pi/180} 0 0" />
      <parent link="${prefix}angle_bracket" />
      <child link="${prefix}gripper_body" />
    </joint>


  </xacro:macro>

</robot>